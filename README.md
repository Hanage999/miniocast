# miniocast

Amazon S3互換のクラウドストレージ、MinIOのバケットをPodcastサーバーにしてしまおうという寸法です。

## 動作環境
+ macOS 10.14.4
+ Go 1.12.4
+ MinIO 2019-04-23T23:50:36Z

## 機能
+ バケット内のフォルダを１つのPodcastサイトとし、そこに存在する音声ファイルをもとに、同一フォルダ内に自動的にfeed.rssとweb.htmlを生成あるいは更新します。同時に複数のPodcastサイトを更新することも可能です。
+ ファイルの名前をエピソードタイトルとして使います。
+ ファイル名に含まれている最初の半角スペースを区切りとして認識し、区切りの前をタイトル、後をDescriptionとして登録します。
+ 区切り以降に「第<半角数字>回」（第023回、第5回など）という文字列が存在する場合は、それをDescriptionではなく、エピソード番号として認識します。数字は全角ダメ、絶対。
+ タイトルにエピソード番号を自動で追加するよう設定することができます（書式：「第~回」）。新エピソードの番号は、既存フィードに含まれている最終エピソードの番号をインクリメントしたものになります。もし既存の最終エピソードに番号が設定されていなければ、既存のエピソードの数に応じて新エピソードの番号を決定します。最初のfeed作成時にエピソード番号を上述の方法で任意に設定しておき、以後の更新では自動的に設定させる、という使い方が可能です。

## miniocastコマンドの使い方
1. 下準備1：MinIOのバケットとPodcastごとのフォルダを作成し、バケットにはRead Onlyポリシーを適用しておく。
1. 下準備2：Podcastにしたいフォルダ直下に、image.jpgという名前でタイトル画像を設置しておく。
1. cmd/miniocast フォルダで go get、go build すると、フォルダに miniocast コマンドができる。MinIOサーバーと同じマシンに置く必要はない。（ただ後述の通り、同一マシンに置いておくと、より便利に使える場合もあるかも）
1. config.yml.example を config.yml にリネームまたはコピーし、バケットとフォルダなどの設定に応じて書き換えるあるいは追記する。
1. フォルダにconfig.ymlとweb.gohtml、web.js、web.cssが存在することを確認して、./miniocast で起動。

## 作成したPodcastの利用方法

1. 作成したPodcastはiTunesストア等で検索しても表示されないので、お使いのアプリにRSSフィードのURL：  
**{minioバケットのurl}/{フォルダ名}/feed.rss** を直接登録してください。
1. **{minioバケットのurl}/{フォルダ名}/web.html** にアクセスすると、シンプルなWebインターフェイスを表示することができます。各エピソードのタイトルをクリックすると、プレイヤーが表示されたり隠れたりします。注意：MinIOはウェブサーバではないので、web.htmlというファイルまで指定しないとサイトが表示されません。
1. web.htmlは、config.ymlでSavePlayStateをtrueにすることにより、ブラウザを閉じたり再読み込みしても各エピソードの再生位置と再生速度を保存することができます。再生状態が保存されているエピソードはタイトルが緑色で表示されます。一時停止中にシークバーで再生位置をゼロに戻せば、保存状態をリセットできます。

## より便利に

たとえばmacOS上でMinIOを運用しているなら、MinIOがサーバーとして使っているローカルフォルダにフォルダアクションを適用できます。

そこで、同一マシンにminiocastと設定ファイルを置き、そのフォルダにファイルが追加されたらminiocastを自動的に起動するようなAutomatorワークフローを組んでおくと便利です（フォルダやコマンドのアクセス権にご注意）。

## Amazon S3 では

……試しておりません。

## 謝辞

Webインターフェイスのデザインは、[Turing Complete FM](https://turingcomplete.fm)の[Rui Ueyama](https://twitter.com/rui314)さんが気前よく公開してくださっているJavaScriptとCSSを使わせていただきました。
